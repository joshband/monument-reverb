name: DSP QA Harness

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  monument_harness_critical:
    runs-on: macos-14
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN != '' && secrets.SUBMODULE_TOKEN || github.token }}

      - name: Cache JUCE FetchContent
        uses: actions/cache@v4
        with:
          path: build-qa/_deps
          key: ${{ runner.os }}-juce-qa-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-juce-qa-

      - name: Configure QA build
        run: cmake -S . -B build-qa -DBUILD_QA_HARNESS=ON -DMONUMENT_ENABLE_TESTS=OFF -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build QA executable
        run: cmake --build build-qa --config Release --target monument_qa

      - name: Run critical suite
        run: ./build-qa/monument_qa_artefacts/Release/monument_qa scenarios/monument/monument_critical_suite.json

      - name: Publish QA job summary
        if: always()
        run: |
          SUMMARY_PATH=""
          SUITE_JSON_PATH=""
          if [ -f qa_output/report/ci_summary.md ]; then
            SUMMARY_PATH="qa_output/report/ci_summary.md"
          elif [ -f qa_output/suite_result.json ]; then
            SUITE_JSON_PATH="qa_output/suite_result.json"
          else
            echo "No QA CI summary or suite_result.json found"
            exit 0
          fi

          if [ -z "$SUMMARY_PATH" ] && [ -n "$SUITE_JSON_PATH" ]; then
            python3 -c 'import json,sys; d=json.load(open(sys.argv[1], "r", encoding="utf-8")); s=d.get("summary", {}); a=d.get("scenarios", []); suite=d.get("suite_id", "qa_suite"); status=d.get("status", "UNKNOWN"); total=s.get("total", len(a)); passed=s.get("passed", 0); warned=s.get("warned", 0); failed=s.get("failed", 0); errors=s.get("errors", 0); skipped=s.get("skipped", 0); print("## QA Suite Job Summary\n"); print("| Suite | Status | Total | Pass | Warn | Fail | Error | Skip |"); print("|---|---:|---:|---:|---:|---:|---:|---:|"); print(f"| `{suite}` | `{status}` | {total} | {passed} | {warned} | {failed} | {errors} | {skipped} |")' "$SUITE_JSON_PATH" > /tmp/qa_ci_summary.md
            SUMMARY_PATH="/tmp/qa_ci_summary.md"
          fi

          if [ -x external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh ]; then
            external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh "$SUMMARY_PATH"
          elif [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            cat "$SUMMARY_PATH" >> "$GITHUB_STEP_SUMMARY"
          else
            cat "$SUMMARY_PATH"
          fi

      - name: Upload critical QA output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monument-qa-critical-output
          path: qa_output/
          retention-days: 7

  monument_harness_full:
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: macos-14
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN != '' && secrets.SUBMODULE_TOKEN || github.token }}

      - name: Cache JUCE FetchContent
        uses: actions/cache@v4
        with:
          path: build-qa/_deps
          key: ${{ runner.os }}-juce-qa-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-juce-qa-

      - name: Configure QA build
        run: cmake -S . -B build-qa -DBUILD_QA_HARNESS=ON -DMONUMENT_ENABLE_TESTS=OFF -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build QA executable
        run: cmake --build build-qa --config Release --target monument_qa

      - name: Run full suite
        run: ./build-qa/monument_qa_artefacts/Release/monument_qa scenarios/monument/monument_suite.json

      - name: Publish QA job summary
        if: always()
        run: |
          SUMMARY_PATH=""
          SUITE_JSON_PATH=""
          if [ -f qa_output/report/ci_summary.md ]; then
            SUMMARY_PATH="qa_output/report/ci_summary.md"
          elif [ -f qa_output/suite_result.json ]; then
            SUITE_JSON_PATH="qa_output/suite_result.json"
          else
            echo "No QA CI summary or suite_result.json found"
            exit 0
          fi

          if [ -z "$SUMMARY_PATH" ] && [ -n "$SUITE_JSON_PATH" ]; then
            python3 -c 'import json,sys; d=json.load(open(sys.argv[1], "r", encoding="utf-8")); s=d.get("summary", {}); a=d.get("scenarios", []); suite=d.get("suite_id", "qa_suite"); status=d.get("status", "UNKNOWN"); total=s.get("total", len(a)); passed=s.get("passed", 0); warned=s.get("warned", 0); failed=s.get("failed", 0); errors=s.get("errors", 0); skipped=s.get("skipped", 0); print("## QA Suite Job Summary\n"); print("| Suite | Status | Total | Pass | Warn | Fail | Error | Skip |"); print("|---|---:|---:|---:|---:|---:|---:|---:|"); print(f"| `{suite}` | `{status}` | {total} | {passed} | {warned} | {failed} | {errors} | {skipped} |")' "$SUITE_JSON_PATH" > /tmp/qa_ci_summary.md
            SUMMARY_PATH="/tmp/qa_ci_summary.md"
          fi

          if [ -x external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh ]; then
            external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh "$SUMMARY_PATH"
          elif [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            cat "$SUMMARY_PATH" >> "$GITHUB_STEP_SUMMARY"
          else
            cat "$SUMMARY_PATH"
          fi

      - name: Upload full QA output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monument-qa-full-output
          path: qa_output/
          retention-days: 30
