name: DSP QA Harness

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  monument_harness_critical:
    runs-on: macos-14
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN != '' && secrets.SUBMODULE_TOKEN || github.token }}

      - name: Cache JUCE FetchContent
        uses: actions/cache@v4
        with:
          path: build-qa/_deps
          key: ${{ runner.os }}-juce-qa-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-juce-qa-

      - name: Configure QA build
        run: cmake -S . -B build-qa -DBUILD_QA_HARNESS=ON -DMONUMENT_ENABLE_TESTS=OFF -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build QA executable
        run: cmake --build build-qa --config Release --target monument_qa

      - name: Run critical suite
        run: ./build-qa/monument_qa_artefacts/Release/monument_qa scenarios/monument/monument_critical_suite.json

      - name: Publish QA job summary
        if: always()
        run: |
          SUMMARY_PATH=""
          if [ -f qa_output/report/ci_summary.md ]; then
            SUMMARY_PATH="qa_output/report/ci_summary.md"
          else
            echo "No qa_output/report/ci_summary.md found"
            exit 0
          fi

          if [ -x external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh ]; then
            external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh "$SUMMARY_PATH"
          elif [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            cat "$SUMMARY_PATH" >> "$GITHUB_STEP_SUMMARY"
          else
            cat "$SUMMARY_PATH"
          fi

      - name: Upload critical QA output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monument-qa-critical-output
          path: qa_output/
          retention-days: 7

  monument_harness_full:
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    runs-on: macos-14
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_TOKEN != '' && secrets.SUBMODULE_TOKEN || github.token }}

      - name: Cache JUCE FetchContent
        uses: actions/cache@v4
        with:
          path: build-qa/_deps
          key: ${{ runner.os }}-juce-qa-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-juce-qa-

      - name: Configure QA build
        run: cmake -S . -B build-qa -DBUILD_QA_HARNESS=ON -DMONUMENT_ENABLE_TESTS=OFF -DCMAKE_OSX_ARCHITECTURES=arm64 -DCMAKE_POLICY_VERSION_MINIMUM=3.5

      - name: Build QA executable
        run: cmake --build build-qa --config Release --target monument_qa

      - name: Run full suite
        run: ./build-qa/monument_qa_artefacts/Release/monument_qa scenarios/monument/monument_suite.json

      - name: Publish QA job summary
        if: always()
        run: |
          SUMMARY_PATH=""
          if [ -f qa_output/report/ci_summary.md ]; then
            SUMMARY_PATH="qa_output/report/ci_summary.md"
          else
            echo "No qa_output/report/ci_summary.md found"
            exit 0
          fi

          if [ -x external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh ]; then
            external/audio-dsp-qa-harness/scripts/publish_ci_summary.sh "$SUMMARY_PATH"
          elif [ -n "${GITHUB_STEP_SUMMARY:-}" ]; then
            cat "$SUMMARY_PATH" >> "$GITHUB_STEP_SUMMARY"
          else
            cat "$SUMMARY_PATH"
          fi

      - name: Upload full QA output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: monument-qa-full-output
          path: qa_output/
          retention-days: 30
